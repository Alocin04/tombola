<h1 class="title center-text">TOMBOLA!</h1>
<div class="container">
    <div class="panel center-text">
        <div class="twelve col">
            <h2 class="center-text">Scegli cartelle</h2>
            <button class="btn btn-fade-link mb-3" data-page="/cartelle/" data-slug="<%= options.fe_opt.room_slug %>">Gioca!</button>
        </div>

        <% options.the_room.cards.forEach((card, index) => { %>

            <div class="four col">
                <table class="table-container single-card selectable card_<%= index %>" data-card="<%= index %>">
                    <tr><td colspan="9">Cartella nÂ°<%= index + 1 %></td></tr>

                    <% for (var i = 0; i < card.content.length; i++) { %>
                        <tr>
                            <% for (var j = 0; j < card.content[i].length; j++) { %>
                                <td><div class="card-number"><%= card.content[i][j] != -1 ? card.content[i][j] : ' ' %></div></td>
                            <% } %>
                        </tr>
                    <% } %>

                </table>
            </div>

        <% }); %>

        <div class="clearfix"></div>
    </div>
    <div class="bottom-links mb-3">
        <a class="link" href="/">&laquo; torna alla pagina principale</a>
    </div>
</div> 

<%- '<script>const fe_options = ' + JSON.stringify(options.fe_opt) + '</script>' %>
<script>
    $(document).ready(function() {
        $('.single-card').click(function() {
            if ($(this).hasClass('selectable')) {
                $(this).toggleClass('selected');

                var selected_cards = JSON.parse(sessionStorage.getItem('selected_cards'));
                if (selected_cards !== null) {
                    if ($(this).hasClass('selected')) {
                        selected_cards.push($(this).data('card'));
                    } else {    
                        selected_cards.splice(selected_cards.indexOf($(this).data('card')), 1);
                    }
                } else {
                    selected_cards = [];
                    if ($(this).hasClass('selected')) {
                        selected_cards.push($(this).data('card'));
                    }
                }
                sessionStorage.setItem('selected_cards', JSON.stringify(selected_cards));

                $.getJSON('/endpoint/set_used_card/?room_name=' + fe_options.room_slug + '&card_id=' + $(this).data('card') + 
                '&card_sel=' + $(this).hasClass('selected'), function(res) {
                    console.log(res.message);
                });
            }
        });

        $('.btn-fade-link').click(function () {
            const btn = this;
            $('.page').fadeOut(500, function() {
                window.location.href = $(btn).data('page') + $(btn).data('slug');
            });
        });

        setInterval(function() {
            $.getJSON('/endpoint/get_used_cards/?room_name=' + fe_options.room_slug, function(res) {
                if (res.status === 'OK') {
                    var selected_cards = JSON.parse(sessionStorage.getItem('selected_cards'));
                    if (selected_cards === null) selected_cards = [];

                    res.data.cards.forEach((taken, index) => {
                        if (!selected_cards.includes(index)) {
                            $('.card_' + index).toggleClass('selectable', !taken).toggleClass('disabled', taken);
                            if (!taken) $('.card_' + index).removeClass('selected', !taken);
                        } else {
                            if (taken) {
                                $('.card_' + index).addClass('selected');
                            } else {
                                sessionStorage.setItem('selected_cards', '[]');
                            }
                        }
                    });
                }

                console.log(res.message);
            });
        }, 500);
    });
</script>